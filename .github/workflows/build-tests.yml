name: ThiefDaily

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        
      - name: Add vala next
        run: sudo add-apt-repository ppa:vala-team/daily

      - name: Update Ubuntu
        run: sudo apt-get update

      - name: Install build essentials
        run: sudo apt-get install build-essential meson ninja-build valac cmake libgspell-1-dev libwebkitgtk-6.0-dev libmarkdown2-dev libxml2-dev libarchive-dev libgtk-4-dev libgee-0.8-dev libgtksourceview-5-dev libsecret-1-dev libadwaita-1-dev liblink-grammar-dev libjson-glib-dev libspelling-1-dev

      - name: Init submodules
        run: git submodule init

      - name: Update submodules
        run: git submodule update --remote --recursive

      - name: Setup Build
        run: meson build

      - name: Configure build
        run: meson configure -Dbuild_tests=true build

      - name: Run Build
        run: ninja -C build

      - name: Test
        run: ./build/tests/tests

      - name: Install flatpak and flatpak builder
        run: sudo apt-get install flatpak flatpak-builder

      - name: Install dependencies for flatpak build
        run: flatpak install flathub org.gnome.Platform//49 org.gnome.Sdk//49 --assumeyes

      - name: Build flatpak
        run: cd flatpak && flatpak-builder --force-clean --install-deps-from=flathub --user --install --repo=repo build-dir com.github.kmwallio.thiefmd.json
